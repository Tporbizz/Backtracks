<!-- Truck Detail Modal -->
<div class="modal fade truck-detail-modal" id="truckDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="close-handle"></div>
            
            <div class="truck-detail-header">
                <div class="truck-owner">
                    <div class="owner-avatar">
                        <span>{{ truck.user.name[0]|upper }}</span>
                    </div>
                    <div class="owner-info">
                        <h2>{{ truck.user.name }}</h2>
                        <div class="rating">
                            ‚òÖ {{ truck.rating }}
                            <span class="review-count">({{ truck.review_count }} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß)</span>
                        </div>
                    </div>
                </div>
                <div class="truck-status {% if truck.is_confirmed %}confirmed{% elif truck.is_expired %}expired{% else %}available{% endif %}">
                    {% if truck.is_confirmed %}
                        <span>‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>
                    {% elif truck.is_expired %}
                        <span>‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤</span>
                    {% else %}
                        <span>‡∏ß‡πà‡∏≤‡∏á</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="truck-map">
                <div id="map"></div>
            </div>
            
            <div class="truck-content">
                <div class="route-info p-2 mb-2 bg-light rounded">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="fw-bold">{{ truck.start }} ‚Üí {{ truck.dest }}</span>
                        <span class="text-primary">{{ truck.return_date|thai_date }}</span>
                    </div>
                    <div class="d-flex justify-content-between text-muted small">
                        <span>{{ truck.plate }} ‚Ä¢ {{ truck.truck_type }}</span>
                        <span class="fw-bold text-success">{{ "{:,}".format(truck.price) }}‡∏ø</span>
                    </div>
                </div>
                
                <div class="route-stats">
                    <div class="stat-row">
                        <div class="stat-icon">üìè</div>
                        <div class="stat-label">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á:</div>
                        <div class="stat-value">{{ distance }} ‡∏Å‡∏°.</div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-icon">‚è±Ô∏è</div>
                        <div class="stat-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:</div>
                        <div class="stat-value">{{ travel_time }}</div>
                    </div>
                </div>
                
                {% if truck.user_id != current_user.id %}
                <div class="truck-actions mt-3">
                    <a href="tel:{{ truck.user.phone }}" class="btn btn-primary btn-sm w-100 mb-2">
                        <span>üìû</span> ‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö
                    </a>
                    <a href="https://line.me/ti/p/~{{ truck.user.phone }}" class="btn btn-outline btn-sm w-100">
                        <span>üí¨</span> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Line
                    </a>
                </div>
                {% else %}
                    {% if not truck.is_confirmed and not truck.is_expired %}
                    <div class="truck-actions mt-3">
                        <form method="POST" action="{{ url_for('confirm_truck', truck_id=truck.id) }}" class="mb-2">
                            <button type="submit" class="btn btn-primary btn-sm w-100">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button>
                        </form>
                        <div class="d-flex gap-2">
                            <a href="{{ url_for('edit_truck', truck_id=truck.id) }}" class="btn btn-outline btn-sm flex-grow-1">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</a>
                            <form method="POST" action="{{ url_for('delete_truck', truck_id=truck.id) }}" class="flex-grow-1">
                                <button type="submit" class="btn btn-outline btn-sm w-100" onclick="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ‡∏ô‡∏µ‡πâ?')">‡∏•‡∏ö</button>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if truck.is_expired %}
                    <div class="truck-actions mt-3">
                        <form method="POST" action="{{ url_for('extend_truck', truck_id=truck.id) }}" class="mb-2">
                            <button type="submit" class="btn btn-primary btn-sm w-100">‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
                        </form>
                        <form method="POST" action="{{ url_for('delete_truck', truck_id=truck.id) }}">
                            <button type="submit" class="btn btn-outline btn-sm w-100" onclick="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ‡∏ô‡∏µ‡πâ?')">‡∏•‡∏ö</button>
                        </form>
                    </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    .modal-sm {
        max-width: 350px;
    }
    
    .truck-detail-header {
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .truck-owner {
        display: flex;
        align-items: center;
    }
    
    .owner-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        margin-right: 10px;
        flex-shrink: 0;
    }
    
    .owner-info h2 {
        font-size: 16px;
        margin-bottom: 2px;
        font-weight: 600;
    }
    
    .rating {
        color: var(--warning-color);
        font-size: 12px;
    }
    
    .review-count {
        color: var(--text-light);
        font-size: 11px;
        margin-left: 3px;
    }
    
    .truck-status {
        padding: 4px 8px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 500;
        flex-shrink: 0;
    }
    
    .truck-status.available {
        background-color: #E3FCEF;
        color: var(--success-color);
    }
    
    .truck-status.confirmed {
        background-color: var(--primary-light);
        color: var(--primary-color);
    }
    
    .truck-status.expired {
        background-color: #FFEBE6;
        color: var(--error-color);
    }
    
    .truck-map {
        height: 150px;
        background-color: #f5f5f5;
    }
    
    #map {
        height: 100%;
    }
    
    .truck-content {
        padding: 12px;
    }
    
    .route-stats {
        background-color: var(--bg-light);
        border-radius: var(--rounded-sm);
        padding: 8px;
        margin-bottom: 10px;
    }
    
    .stat-row {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    
    .stat-icon {
        margin-right: 8px;
        font-size: 16px;
        flex-shrink: 0;
    }
    
    .stat-label {
        font-size: 12px;
        color: var(--text-light);
        margin-right: 8px;
        width: 75px;
    }
    
    .stat-value {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-dark);
    }
</style>

<script>
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≠‡∏á DOM ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    function openChatModal(truckId, driverName) {
        try {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á modal ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≥
            let oldModal = document.getElementById('chatModal');
            if (oldModal) {
                oldModal.remove();
            }
            
            const chatModalHTML = `
                <div class="modal fade" id="chatModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-chat-dots me-2"></i> 
                                    ‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö <span id="chat-receiver-name"></span>
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0">
                                <div class="chat-container">
                                    <div class="chat-messages" id="chat-messages">
                                        <div class="chat-message-date">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                                    </div>
                                    <div class="chat-input-container">
                                        <input type="text" class="chat-input" id="chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...">
                                        <button class="chat-send-btn" id="chat-send-btn">
                                            <i class="bi bi-send-fill"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const modalElement = document.createElement('div');
            modalElement.innerHTML = chatModalHTML;
            document.body.appendChild(modalElement.firstElementChild);
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÅ‡∏•‡∏∞ truck ID
            document.getElementById('chat-receiver-name').textContent = driverName;
            document.getElementById('chatModal').setAttribute('data-truck-id', truckId);
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `
                <div class="chat-message-date">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                <div class="chat-message received">
                    <div class="chat-bubble">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö</div>
                    <div class="chat-time">10:45</div>
                </div>
            `;
            
            // ‡∏£‡∏≠‡πÉ‡∏´‡πâ DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° event listener
            setTimeout(() => {
                const sendButton = document.getElementById('chat-send-btn');
                const chatInput = document.getElementById('chat-input');
                
                if (sendButton) {
                    sendButton.addEventListener('click', sendChatMessage);
                }
                
                if (chatInput) {
                    chatInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            sendChatMessage();
                        }
                    });
                    
                    // ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î modal
                    chatInput.focus();
                }
            }, 300);
            
            // ‡πÅ‡∏™‡∏î‡∏á modal
            const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
            chatModal.show();
        } catch (error) {
            console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î chat modal:", error);
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ä‡∏ó‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á");
        }
    }
    
    function sendChatMessage() {
        try {
            const input = document.getElementById('chat-input');
            if (!input) return;
            
            const message = input.value.trim();
            
            if (message) {
                const messagesContainer = document.getElementById('chat-messages');
                if (!messagesContainer) return;
                
                const now = new Date();
                const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                                now.getMinutes().toString().padStart(2, '0');
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á
                messagesContainer.innerHTML += `
                    <div class="chat-message sent">
                        <div class="chat-bubble">${message}</div>
                        <div class="chat-time">${timeString}</div>
                    </div>
                `;
                
                // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô input
                input.value = '';
                
                // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà
                setTimeout(() => {
                    messagesContainer.innerHTML += `
                        <div class="chat-message received">
                            <div class="chat-bubble">‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ ‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏£‡∏±‡∏ö</div>
                            <div class="chat-time">${timeString}</div>
                        </div>
                    `;
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 1000);
            }
        } catch (error) {
            console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:", error);
        }
    }
</script>